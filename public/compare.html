<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Comparison Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            max-width: 2400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
        }

        .controls {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #0052a3;
        }

        #results {
            margin-top: 20px;
        }

        .stock-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stock-item {
            background: #e1f0ff;
            color: #0066cc;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: background 0.2s;
        }

        .stock-item:hover {
            background: #cce0ff;
        }

        .error {
            color: red;
            margin-top: 10px;
        }

        .info {
            color: #666;
            margin-top: 10px;
        }

        .summary {
            font-size: 1.1em;
            margin-bottom: 15px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>Stock Comparison Tool (Fubon vs TWSE)</h1>

    <div class="controls">
        <p>Finds stocks present in both Fubon ranking and TWSE Warrant ranking for the selected date.</p>

        <div style="margin-bottom: 15px;">
            <label for="dateSelect">選擇日期 (Select Date):</label>
            <select id="dateSelect"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white; margin-left: 10px; min-width: 200px;">
                <option value="">載入中...</option>
            </select>
        </div>

        <div style="margin-bottom: 15px;">
            <label for="rankingSelect">選擇 Fubon 排行類型 (Select Ranking Type):</label>
            <select id="rankingSelect"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white; margin-left: 10px; min-width: 250px;">
                <option value="">請先選擇日期...</option>
            </select>
        </div>

        <div style="margin-bottom: 15px;">
            <label>Fubon Rank Limit (前幾名): <input type="number" id="fubonLimit" value="20" min="1"
                    style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"></label>
            <label style="margin-left: 20px;">TWSE Rank Limit (前幾名): <input type="number" id="twseLimit" value="20"
                    min="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"></label>
        </div>

        <button onclick="compareStocks()" id="compareButton" style="display: none;">Compare Selected Date</button>
        <div id="status" class="info"></div>
    </div>

    <div id="results"></div>

    <script>
        // Environment detection
        const isGitHubPages = window.location.hostname.includes('github.io');
        const repoName = 'stock_data';
        const basePath = isGitHubPages ? `/${repoName}` : '..';

        // Load available dates on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadAvailableDates();
        });

        async function loadAvailableDates() {
            const dateSelect = document.getElementById('dateSelect');
            dateSelect.innerHTML = '<option value="">載入中...</option>';

            try {
                // 以 Fubon 的檔案日期為主建立下拉選單
                const response = await fetch(`${basePath}/data_fubon/files.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Get files list directly (it's already JSON)
                const fubonFiles = await response.json();

                // 從 Fubon 檔名萃取日期
                // Format: fubon_YYYYMMDD_排行類型.csv
                const dateSet = new Set();
                fubonFiles.forEach(f => {
                    const match = f.match(/fubon_(\d{8})_/);
                    if (match) {
                        dateSet.add(match[1]);
                    }
                });

                const dates = Array.from(dateSet).sort().reverse(); // 新到舊

                // Populate dropdown
                dateSelect.innerHTML = '<option value="">請選擇日期...</option>';
                dates.forEach(dateStr => {
                    const year = dateStr.substring(0, 4);
                    const month = dateStr.substring(4, 6);
                    const day = dateStr.substring(6, 8);
                    const option = document.createElement('option');
                    option.value = dateStr;
                    option.textContent = `${year}/${month}/${day}`;
                    dateSelect.appendChild(option);
                });

                // Auto-select latest date
                if (dates.length > 0) {
                    dateSelect.value = dates[0];
                    // Load ranking types for the selected date (no previous ranking on initial load)
                    await loadAvailableRankings(dates[0], null);
                }

                // Add event listener for date change
                dateSelect.addEventListener('change', async (e) => {
                    if (e.target.value) {
                        // Remember the previously selected ranking type
                        const rankingSelect = document.getElementById('rankingSelect');
                        const previousRanking = rankingSelect.value;
                        await loadAvailableRankings(e.target.value, previousRanking);
                        // Auto-trigger compare after ranking types are loaded
                        if (rankingSelect.value) {
                            await compareStocks();
                        }
                    } else {
                        const rankingSelect = document.getElementById('rankingSelect');
                        rankingSelect.innerHTML = '<option value="">請先選擇日期...</option>';
                    }
                });

                // Setup auto-compare for all inputs
                setupAutoCompare();
            } catch (err) {
                console.error('Error loading dates:', err);
                dateSelect.innerHTML = '<option value="">載入失敗</option>';
            }
        }

        async function loadAvailableRankings(selectedDate, previousRanking = null) {
            const rankingSelect = document.getElementById('rankingSelect');
            rankingSelect.innerHTML = '<option value="">載入中...</option>';

            try {
                const response = await fetch(`${basePath}/data_fubon/files.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const fubonFiles = await response.json();

                // Extract ranking types for the selected date
                // Format: fubon_YYYYMMDD_排行類型.csv
                const rankings = new Set();
                fubonFiles.forEach(f => {
                    if (f.includes(selectedDate)) {
                        // Extract ranking type: fubon_YYYYMMDD_排行類型.csv
                        const match = f.match(/fubon_\d{8}_(.+)\.csv$/);
                        if (match) {
                            rankings.add(match[1]);
                        }
                    }
                });

                // Sort rankings
                const sortedRankings = Array.from(rankings).sort();

                // Populate dropdown
                rankingSelect.innerHTML = '<option value="">請選擇排行類型...</option>';
                sortedRankings.forEach(ranking => {
                    const option = document.createElement('option');
                    option.value = ranking;
                    option.textContent = ranking;
                    rankingSelect.appendChild(option);
                });

                // Try to preserve the previous selection if it exists in the new date's rankings
                if (previousRanking && sortedRankings.includes(previousRanking)) {
                    rankingSelect.value = previousRanking;
                } else {
                    // Auto-select "上市主力買超10日排行" if available
                    if (sortedRankings.includes('上市主力買超10日排行')) {
                        rankingSelect.value = '上市主力買超10日排行';
                    } else if (sortedRankings.length > 0) {
                        rankingSelect.value = sortedRankings[0];
                    }
                }

                // Auto-trigger compare after ranking is selected
                if (rankingSelect.value) {
                    await compareStocks();
                }
            } catch (err) {
                console.error('Error loading rankings:', err);
                rankingSelect.innerHTML = '<option value="">載入失敗</option>';
            }
        }

        function setupAutoCompare() {
            // Get all input and select elements
            const dateSelect = document.getElementById('dateSelect');
            const rankingSelect = document.getElementById('rankingSelect');
            const fubonLimit = document.getElementById('fubonLimit');
            const twseLimit = document.getElementById('twseLimit');

            // Add change event listeners
            rankingSelect.addEventListener('change', () => {
                if (dateSelect.value && rankingSelect.value) {
                    compareStocks();
                }
            });

            fubonLimit.addEventListener('change', () => {
                if (dateSelect.value && rankingSelect.value) {
                    compareStocks();
                }
            });

            fubonLimit.addEventListener('input', () => {
                if (dateSelect.value && rankingSelect.value) {
                    compareStocks();
                }
            });

            twseLimit.addEventListener('change', () => {
                if (dateSelect.value && rankingSelect.value) {
                    compareStocks();
                }
            });

            twseLimit.addEventListener('input', () => {
                if (dateSelect.value && rankingSelect.value) {
                    compareStocks();
                }
            });
        }

        async function compareStocks() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const dateSelect = document.getElementById('dateSelect');
            const rankingSelect = document.getElementById('rankingSelect');
            const selectedDate = dateSelect.value;
            const selectedRanking = rankingSelect.value;
            const fubonLimit = parseInt(document.getElementById('fubonLimit').value) || Infinity;
            const twseLimit = parseInt(document.getElementById('twseLimit').value) || Infinity;

            if (!selectedDate) {
                statusDiv.innerHTML = '<span class="error">請選擇日期</span>';
                return;
            }

            if (!selectedRanking) {
                statusDiv.innerHTML = '<span class="error">請選擇 Fubon 排行類型</span>';
                return;
            }

            statusDiv.textContent = `Analyzing date: ${selectedDate}, ranking: ${selectedRanking}...`;
            resultsDiv.innerHTML = '';

            try {
                // 1. Fetch file lists
                const [fubonFiles, twseFiles] = await Promise.all([
                    fetch(`${basePath}/data_fubon/files.json`).then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    }),
                    fetch(`${basePath}/data_twse/files.json`).then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    })
                ]);

                // 2. Find Fubon file for selected date and ranking type
                const fubonFile = fubonFiles.find(f => f.includes(selectedDate) && f.includes(selectedRanking));

                // 2b. Find TWSE file (只允許同日或前一天 fallback):
                //     - 若有與 selectedDate 相同的日期，就用那一天
                //     - 若沒有，且有前一天的檔案，就以前一天為主
                //     - 以上都沒有才顯示錯誤
                let twseFile = null;
                let twseDateUsed = null;
                const twseMap = new Map(); // date -> file
                twseFiles.forEach(f => {
                    const m = f.match(/^(\d{8})發行之標的證券排行\.csv$/);
                    if (m) {
                        twseMap.set(m[1], f);
                    }
                });

                const toDateObj = (yyyymmdd) => {
                    const y = parseInt(yyyymmdd.substring(0, 4), 10);
                    const m = parseInt(yyyymmdd.substring(4, 6), 10);
                    const d = parseInt(yyyymmdd.substring(6, 8), 10);
                    return new Date(y, m - 1, d);
                };
                const toYYYYMMDD = (dateObj) => {
                    const y = dateObj.getFullYear();
                    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const d = String(dateObj.getDate()).padStart(2, '0');
                    return `${y}${m}${d}`;
                };

                const selectedDateObj = toDateObj(selectedDate);
                const prevDateObj = new Date(selectedDateObj);
                prevDateObj.setDate(prevDateObj.getDate() - 1);
                const prevDate = toYYYYMMDD(prevDateObj);

                if (twseMap.has(selectedDate)) {
                    twseDateUsed = selectedDate;
                    twseFile = twseMap.get(selectedDate);
                } else if (twseMap.has(prevDate)) {
                    twseDateUsed = prevDate;
                    twseFile = twseMap.get(prevDate);
                }

                if (!fubonFile) {
                    statusDiv.innerHTML = `<span class="error">找不到 Fubon 資料檔案 (日期: ${selectedDate}, 排行類型: ${selectedRanking})</span>`;
                    return;
                }

                if (!twseFile) {
                    statusDiv.innerHTML = `<span class="error">找不到 TWSE 資料檔案 (日期: ${selectedDate} 或前一天 ${prevDate})</span>`;
                    return;
                }

                if (twseDateUsed && twseDateUsed !== selectedDate) {
                    statusDiv.textContent = `Found Fubon date ${selectedDate}，TWSE 最新可用資料為 ${twseDateUsed}，以該日期權證資料分析中...`;
                } else {
                    statusDiv.textContent = `Found files for ${selectedDate}. Analyzing...`;
                }

                // 3. Fetch files for selected date
                const [fubonContent, twseContent] = await Promise.all([
                    fetch(`${basePath}/data_fubon/${fubonFile}`).then(r => {
                        if (!r.ok) throw new Error(`Failed to fetch Fubon file: ${r.status}`);
                        return r.text();
                    }),
                    fetch(`${basePath}/data_twse/${twseFile}`).then(r => {
                        if (!r.ok) throw new Error(`Failed to fetch TWSE file: ${r.status}`);
                        return r.text();
                    })
                ]);

                // 4. Parse and intersect
                const fubonStocks = extractStocks(fubonContent, 'fubon', fubonLimit);
                const twseStocks = extractStocks(twseContent, 'twse', twseLimit);

                // Intersect based on stock code
                // Fubon format: "2330 台積電" or "00637L元大滬深300正2" (Code Name)
                // TWSE format: Rank, Code, Name, Count -> "2330" (Code), "台積電" (Name)

                // Extract stock codes from Fubon (handle formats like "00637L元大滬深300正2")
                const fubonCodes = new Set();
                fubonStocks.forEach((stockInfo, code) => {
                    fubonCodes.add(code);
                });

                // Normalize to Code for intersection
                const commonCodes = new Set([...fubonCodes].filter(code => twseStocks.has(code)));

                // 5. Fetch stock data JSON for SMA20 values
                let stockData = {};
                try {
                    const stockDataResponse = await fetch(`${basePath}/data_fubon/fubon_${selectedDate}_sma.json`);
                    if (stockDataResponse.ok) {
                        const stockDataText = await stockDataResponse.text();
                        if (!stockDataText.trim().startsWith('<!DOCTYPE')) {
                            stockData = JSON.parse(stockDataText);
                        }
                    }
                } catch (err) {
                    console.warn('Failed to load stock data JSON:', err);
                    // Continue without SMA20 data
                }

                // 6. Display results
                // Format date for display: YYYYMMDD -> YYYY/MM/DD
                const year = selectedDate.substring(0, 4);
                const month = selectedDate.substring(4, 6);
                const day = selectedDate.substring(6, 8);
                const displayDate = `${year}/${month}/${day}`;

                let twseDisplay = '';
                if (twseDateUsed) {
                    const ty = twseDateUsed.substring(0, 4);
                    const tm = twseDateUsed.substring(4, 6);
                    const td = twseDateUsed.substring(6, 8);
                    const twseDisplayDate = `${ty}/${tm}/${td}`;
                    if (twseDateUsed === selectedDate) {
                        twseDisplay = `${twseDisplayDate} (${twseDateUsed})`;
                    } else {
                        twseDisplay = `${twseDisplayDate} (${twseDateUsed}, 使用最近可用資料)`;
                    }
                }

                let html = `<div class="summary">
                    <strong>日期 (Date):</strong> ${displayDate} (${selectedDate})<br>
                    <strong>Fubon 排行類型 (Ranking Type):</strong> ${selectedRanking}<br>
                    <strong>Fubon File:</strong> ${fubonFile} (Top ${fubonLimit}, found ${fubonStocks.size} stocks)<br>
                    <strong>TWSE File:</strong> ${twseFile} (Top ${twseLimit}, found ${twseStocks.size} stocks)<br>
                    ${twseDisplay ? `<strong>TWSE 日期 (Warrant Date):</strong> ${twseDisplay}<br>` : ''}
                    <strong>交集 (Intersection):</strong> ${commonCodes.size} stocks
                </div>`;

                if (commonCodes.size > 0) {
                    html += '<div class="stock-list">';
                    Array.from(commonCodes).sort().forEach(code => {
                        const fubonInfo = fubonStocks.get(code);
                        const twseInfo = twseStocks.get(code);
                        const name = fubonInfo?.name || twseInfo?.name || '';
                        const price = fubonInfo?.price || '';
                        const displayName = `${code} ${name}`;
                        const url = `https://fubon-ebrokerdj.fbs.com.tw/z/zc/zcw/zcw1_${code}.djhtm`;

                        // Get SMA20 value if available
                        const sma20 = stockData[code]?.[displayDate]?.SMA20;
                        let extraInfo = '';
                        if (price) {
                            extraInfo += ` <span style="color: #d32f2f; font-size: 0.9em; font-weight: bold;">(${price})</span>`;
                        }
                        if (sma20) {
                            extraInfo += ` <span style="color: #666; font-size: 0.9em;">(SMA20: ${sma20})</span>`;
                        }

                        html += `<a href="${url}" target="_blank" class="stock-item">${displayName}${extraInfo}</a>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p>No common stocks found.</p>';
                }

                resultsDiv.innerHTML = html;
                statusDiv.textContent = 'Analysis complete.';

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = `<span class="error">Error: ${err.message}</span>`;
            }
        }

        function extractStocks(csvContent, type, limit) {
            const rows = csvContent.split('\n').map(r => r.trim()).filter(r => r);
            const stocks = new Map(); // Code -> {name, price}
            let count = 0;

            if (type === 'fubon') {
                // Header: Rank,Stock,Price...
                // Stock col: "2330 台積電" or "00637L元大滬深300正2"
                const headers = parseCSVRow(rows[0]);
                const stockIdx = headers.findIndex(h => h.includes('Stock') || h.includes('股票名稱'));
                const priceIdx = headers.findIndex(h => h.includes('Price') || h.includes('價格'));

                for (let i = 1; i < rows.length; i++) {
                    if (count >= limit) break;

                    const cols = parseCSVRow(rows[i]);
                    if (cols[stockIdx]) {
                        const val = cols[stockIdx].trim();

                        // Extract stock code: 數字+英文的組合，直到空格或中文字出現為止
                        const allMatches = val.match(/[\d]+[A-Za-z]*/g);
                        let code = null;
                        let name = '';

                        if (allMatches && allMatches.length > 0) {
                            // 優先選擇包含字母的匹配（股票代碼通常有字母，排名沒有）
                            const withLetter = allMatches.find(m => /[A-Za-z]/.test(m));
                            if (withLetter) {
                                code = withLetter;
                                // Extract name after the code
                                const codeIndex = val.indexOf(code);
                                if (codeIndex !== -1) {
                                    name = val.substring(codeIndex + code.length).trim();
                                }
                            } else {
                                // 如果沒有包含字母的，選擇最長的（股票代碼通常是4-6位，排名是1-2位）
                                code = allMatches.reduce((a, b) => a.length > b.length ? a : b);
                                // Extract name after the code
                                const codeIndex = val.indexOf(code);
                                if (codeIndex !== -1) {
                                    name = val.substring(codeIndex + code.length).trim();
                                }
                            }
                        }

                        if (code && /^\d+/.test(code)) {
                            // Extract price from Price column
                            const price = priceIdx >= 0 && cols[priceIdx] ? cols[priceIdx].trim() : '';
                            stocks.set(code, { name, price });
                            count++;
                        }
                    }
                }
            } else if (type === 'twse') {
                // Header: 排行,權證標的代號,權證標的名稱,發行檔數
                // Code idx: 1, Name idx: 2
                for (let i = 1; i < rows.length; i++) {
                    if (count >= limit) break;

                    const cols = parseCSVRow(rows[i]);
                    if (cols.length >= 3) {
                        const code = cols[1];
                        const name = cols[2];
                        stocks.set(code, { name, price: '' }); // TWSE doesn't have price
                        count++;
                    }
                }
            }
            return stocks;
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
    </script>
</body>

</html>