name: Supplement Data

on:
  workflow_dispatch:
    inputs:
      startDate:
        description: 'Start Date (YYYY/MM/DD or YYYY-MM-DD)'
        required: true
        default: '2025/11/02'

jobs:
  crawl-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Install Playwright Browsers
      run: npx playwright install chromium

    - name: Run History SMA Crawler
      # transform 2025/11/02 to 2025/11/02 (format matches)
      run: node scripts/crawl_history_sma.js --start "${{ github.event.inputs.startDate }}"

    - name: Run Institutional Investors Crawler
      # transform 2025/11/02 to 2025-11-02 if needed, 
      # but crawl_institutional_investors.js handles some formats or let's ensure we pass YYYY-MM-DD
      # The script expects YYYY-MM-DD for URL params ideally, or parses it.
      # Let's simple string replace / to - just in case or rely on script parsing
      run: |
        START_DATE="${{ github.event.inputs.startDate }}"
        START_DATE_DASH=${START_DATE//\//-}
        echo "Using Start Date: $START_DATE_DASH"
        node scripts/crawl_institutional_investors.js --start "$START_DATE_DASH"

    - name: Commit and Push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add data_history_sma/ data_institutional/
        # Check if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "chore: supplement data (start date ${{ github.event.inputs.startDate }})"
          git push
        fi
